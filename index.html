<html>
<head>
<title>echolocation</title>
<style type="text/css">
body {font-family: Arial; font-size: small; color: white;}
table {position: relative; z-index: 100;}
canvas {position: absolute; top: 10px; left: 10px; border: 1px solid #424242;}
td.move {width: 17px; height: 22px; border: 1px solid #424242; text-align:center; position: relative; background-color: black;}
td.decloak {width: 20px; height: 22px; border: 1px solid #424242; text-align:center; position: relative; background-color: black;}
img.mirror {transform:scale(-1, 1); -webkit-transform:scale(-1, 1);}
img.overlay {position: absolute; top: 0px; left: 0px;}
td.button {width: 50px; height: 50px; position: relative; text-align: center;}
td.options {width: 38px; height: 30px; position: relative; border: 1px solid #424242; text-align: center;}
img.overlayC {position: absolute; top: 0px; left: 0px; opacity: 0;}
img.overlayM {position: absolute; top: 0px; left: 0px; opacity: 0;}
a.select {color: gray;}
</style>
<script type="text/javascript">
<!--

var pi = Math.PI;

var rBank = [0, 80, 130, 180];
var rTurn = [0, 35, 63, 90];

var timer = [0, 0, 0, 0, 0, 0, 0, 0];

var phantom = new Object();
phantom.faction = "empire";
phantom.id = "phantom";
phantom.width = 40;
phantom.protrusions = 17;
phantom.nubs = 1;
phantom.height = phantom.width + phantom.protrusions + phantom.nubs;
phantom.pilots = [echo];
phantom.decloak = [
["straight", "blue", 2],
["roll", "blue", 2, -1, 1],
["roll", "blue", 2, 1, 1],
["roll", "blue", 2, -1, -1],
["roll", "blue", 2, 1, -1]
];
phantom.dial = [
["turn", "white", 1, -1],
["turn", "white", 1, 1],
["turn", "white", 2, -1],
["bank", "green", 2, -1],
["straight", "green", 2],
["bank", "green", 2, 1],
["turn", "white", 2, 1],
["turn", "white", 3, -1],
["bank", "white", 3, -1],
["straight", "green", 3],
["bank", "white", 3, 1],
["turn", "white", 3, 1],
["straight", "white", 4]
];

var echo = new Object();
echo.id = "echo";
echo.img = new Image();
echo.img.src = "echo.png";
echo.img.onload = function() {initialize();};
echo.decloak = [
["bank", "blue", 2, -1],
["bank", "blue", 2, 1],
["bankroll", "blue", 2, -1, 1, 1],
["bankroll", "blue", 2, -1, -1, 1],
["bankroll", "blue", 2, 1, 1, -1],
["bankroll", "blue", 2, 1, -1, -1],
["bankroll", "blue", 2, -1, 1, -1],
["bankroll", "blue", 2, -1, -1, -1],
["bankroll", "blue", 2, 1, 1, 1],
["bankroll", "blue", 2, 1, -1, 1]
];

var ship = new Object();

var decloak;
var dial;
var looping = false;
var stars = false;

var firingarcs = 0;
var barrel_rolls = 0;
var barrel_roll_timer = [0, 0];
var boosts = 0;
var boost_timer = [0, 0];

function initialize () {
	select(phantom, echo);
	gridlayer = document.getElementById("gridlayer");
	gridlayer.style.zIndex = -1;
	layer0 = document.getElementById("layer0");
	layer0.style.zIndex = 0;
	layer1 = document.getElementById("layer1");
	layer1.style.zIndex = 3;
	layer2 = document.getElementById("layer2");
	layer2.style.zIndex = 4;
	layer3 = document.getElementById("layer3");
	layer3.style.zIndex = 7;
	ctx = [layer0.getContext("2d"), layer1.getContext("2d"), layer2.getContext("2d"), layer3.getContext("2d")];
	gctx = gridlayer.getContext("2d")
	starfield(stars);
	setInterval(function(){step()}, 35);
};

function select (model, pilot) {
	var selections = document.getElementsByClassName("select");
	for (var i = 0; i < selections.length; i++) {
		document.getElementsByClassName("select")[i].style.color = "gray";
	};
	document.getElementById("select_" + model.faction).style.color = "white";
	ship.dial = model.dial;
	if (pilot != undefined) {
		document.getElementById("select_" + pilot.id).style.color = "white";
		ship.decloak = pilot.decloak;
		decloakGrid(1);
	} else {
		document.getElementById("select_" + model.id).style.color = "white";
		ship.decloak = model.decloak;
		decloakGrid(0);
	};
	decloak = undefined;
	dial = undefined;
	setDecloak("all");
	setDial("all");
};

function reset () {
	for (var i =  1; i < ctx.length; i++) {
		ctx[i].setTransform(1, 0, 0, 1, 0, 0);
		ctx[i].clearRect(0, 0, 800, 600);
		ctx[i].translate(800 / 2, 600 * 2 / 3);
	};
};

function setDecloak (index, index2) {
	var overlays = document.getElementsByClassName("overlayC");
	var all = (decloak != undefined && ship.decloak.length == decloak.length);
	if (index == "all") {
		for (var i = 0; i < overlays.length; i++) {
			document.getElementsByClassName("overlayC")[i].style.opacity = (all) ? 0.7 : 0;
			decloak = (all) ? [] : ship.decloak.slice(0);
		};
	} else {
		var on = decloak.indexOf(ship.decloak[index]);
		id = "decloak" + index;
		document.getElementById(id).style.opacity = (on == -1) ? 0 : 0.7;
		if (on == -1) {
			decloak.push(ship.decloak[index]);
		} else {
			decloak.splice(on, 1);
		};
		if (index2 != undefined) {
			on = decloak.indexOf(ship.decloak[index2]);
			if (on == -1) {
				decloak.push(ship.decloak[index2]);
			} else {
				decloak.splice(on, 1);
			};
		};
	};
};

function setDial (index) {
	var overlays = document.getElementsByClassName("overlayM");
	var all = (dial != undefined && ship.dial.length == dial.length);
	if (index == "all") {
		for (var i = 0; i < overlays.length; i++) {
			document.getElementsByClassName("overlayM")[i].style.opacity = (all) ? 0.7 : 0;
			dial = (all) ? [] : ship.dial.slice(0);
		};
	} else {
		var on = dial.indexOf(ship.dial[index]);
		id = "dial" + index;
		document.getElementById(id).style.opacity = (on == -1) ? 0 : 0.7;
		if (on == -1) {
			dial.push(ship.dial[index]);
		} else {
			dial.splice(on, 1);
		};
	};
};

function loop () {
	if (looping) {
		looping = false;
		document.getElementById("button_loop").style.opacity = 0.5;
	} else {
		looping = true;
		document.getElementById("button_loop").style.opacity = 0;
		timer = [0, 0, 0, 0, 0, 0, 0, 0];
	};
};

function barrel_roll () {
	if (barrel_rolls == 1) {
		barrel_rolls = 0;
		document.getElementById("button_barrel").style.opacity = 0.5;
		barrel_roll_timer[0] = timer[4];
		barrel_roll_timer[1] = timer[5];
		timer[4] = 0;
		timer[5] = 0;
	} else {
		barrel_rolls = 1;
		document.getElementById("button_barrel").style.opacity = 0;
		timer[4] = barrel_roll_timer[0];
		timer[5] = barrel_roll_timer[1];
	};
};

function boost () {
	if (boosts == 1) {
		boosts = 0;
		document.getElementById("button_boost").style.opacity = 0.5;
		boost_timer[0] = timer[6];
		boost_timer[1] = timer[7];
		timer[6] = 0;
		timer[7] = 0;
	} else {
		boosts = 1;
		document.getElementById("button_boost").style.opacity = 0;
		timer[6] = boost_timer[0];
		timer[7] = boost_timer[1];
	};
};

function starfield (state) {
	if (state) {
		ctx[0].fillStyle = "white";
		for (var i = 0; i < 42; i++) {
			var x = 10 + Math.random() * 780;
			var y = 10 + Math.random() * 580;
			var r = Math.random() * 5;
			for (var size = r; size > 0; size--) {
				ctx[0].beginPath();
				ctx[0].moveTo(x, y);
				ctx[0].arc (x, y, size, 0, 2 * pi);
				ctx[0].globalAlpha = 1/size;
				ctx[0].fill();
			};
		};
		stars = false;
		document.getElementById("button_star").style.opacity = 0;
	} else {
		ctx[0].clearRect(0, 0, 800, 600);
		stars = true;
		document.getElementById("button_star").style.opacity = 0.5;
	};
};

function gridfield () {
	gctx.clearRect(0, 0, 800, 600);
	var z = Number(gridlayer.style.zIndex);
	if (z < 8) {
		gridlayer.style.zIndex = z + 3;
		gctx.globalAlpha = 0.1;
		gctx.beginPath();
		gctx.fillStyle = "#FF3300";
		gctx.fillRect(0, 0, 800, 600);
		gctx.globalAlpha = 1;
		gctx.strokeStyle = "#FF8800";
		gctx.lineWidth = 1;
		for (var i = 20; i < 800; i += 40) {
			gctx.beginPath();
			gctx.moveTo(i, 0);
			gctx.lineTo(i, 600);
			gctx.stroke();
		};
		for (var i = 40; i < 600; i += 40) {
			gctx.beginPath();
			gctx.moveTo(0, i);
			gctx.lineTo(800, i);
			gctx.stroke();
		};
		switch (Number(gridlayer.style.zIndex)) {
			case 2:
				document.getElementById("grid_level").innerHTML = "1";
				break;
			case 5:
				document.getElementById("grid_level").innerHTML = "2";
				break;
			case 8:
				document.getElementById("grid_level").innerHTML = "3";
				break;
		};
		document.getElementById("button_grid").style.opacity = 0;
	} else {
		gridlayer.style.zIndex = -1;
		document.getElementById("grid_level").innerHTML = "";
		document.getElementById("button_grid").style.opacity = 0.5;
	};
};

function fire () {
	firingarcs++;
	if (firingarcs > 3) {
		firingarcs = 0;
		document.getElementById("button_fire").style.opacity = 0.5;
		document.getElementById("fire_range").innerHTML = "";
	} else {
		document.getElementById("button_fire").style.opacity = 0;
		document.getElementById("fire_range").innerHTML = firingarcs;
	};
};

function drawFiringArcs (x, y) {
	ctx[2].globalAlpha = 1;
	ctx[2].fillStyle = "orange";
	ctx[2].strokeStyle = "orange";
	ctx[2].beginPath();
	ctx[2].rect(x - 17, y - 100 * firingarcs, 34, 100 * firingarcs);
	ctx[2].fill();
	ctx[2].beginPath();
	ctx[2].lineWidth = 100 * firingarcs;
	ctx[2].arc (x - 16, y, 50 * firingarcs, 1.5 * pi, (1.5 - 2/9) * pi, true);
	ctx[2].stroke();
	ctx[2].beginPath();
	ctx[2].lineWidth = 100 * firingarcs;
	ctx[2].arc (x + 16, y, 50 * firingarcs, 1.5 * pi, (1.5 + 2/9) * pi, false);
	ctx[2].stroke();
};

function step () {
	reset();
	if (timer[0] < 100) {
		timer[0] += 5;
	};
	if (timer[0] >= 100 && timer[1] < 100) {
		timer[1] += 2
	};
	if (timer[1] >= 100 && timer[2] < 100) {
		timer[2] += 5;
	};
	if (timer[2] >= 100 && timer[3] < 100) {
		timer[3] += 2
	};
	if (timer[3] >= 100 && timer[4] < 100 && barrel_rolls == 1) {
		timer[4] += 5
	};
	if (timer[4] >= 100 && timer[5] < 100 && barrel_rolls == 1) {
		timer[5] += 2
	};
	if (timer[3] >= 100 && timer[6] < 100 && boosts == 1) {
		timer[6] += 5
	};
	if (timer[6] >= 100 && timer[7] < 100 && boosts == 1) {
		timer[7] += 2
	};
	for (var i = 0; i < decloak.length; i++) {
		animate(decloak[i], 0);
	};
	if (looping && timer[2] >= 100 && timer[3] >= 100 && timer[2 + barrel_rolls * 2] >= 100 && timer[3 + barrel_rolls * 2] >= 100 && timer[2 + boosts * 4] >= 100 && timer[3 + boosts * 4] >= 100) {
		setTimeout(function(){timer_reset();}, 3000);
	};
	drawPhantom(3, 0, 0, 1 - timer[0] / 400 - timer[1] / 400);
};

function timer_reset () {
	if (looping && timer[2] >= 100 && timer[3] >= 100 && timer[2 + barrel_rolls * 2] >= 100 && timer[3 + barrel_rolls * 2] >= 100 && timer[2 + boosts * 4] >= 100 && timer[3 + boosts * 4] >= 100) {
		timer = [-5, 0, -5, 0, 0, 0, 0, 0];
		barrel_roll_timer = [0, 0];
		boost_timer = [0, 0];
	};
};

function drawPhantom (z, x, y, alpha) {
	ctx[z].globalAlpha = alpha;
	ctx[z].drawImage(echo.img, x - phantom.width / 2, y - phantom.protrusions, phantom.width, phantom.height);
	if (firingarcs && timer[3] == 100 && alpha == 1) {
		drawFiringArcs(x, y);
	};
};

function oBank (z, distance, direction) {
	var radius = rBank[distance];
	ctx[z].translate(direction * radius, 0);
	ctx[z].rotate(direction * 0.25 * pi);
	ctx[z].translate(direction * -radius, -phantom.width);
};

function oBankroll (z, distance, direction, start, end, bank) {
	var radius = rBank[distance];
	ctx[z].translate(direction * phantom.width / 2, phantom.width / 2 - start * phantom.width / 4);
	ctx[z].rotate(direction * 0.5 * pi);
	ctx[z].translate(bank * radius, 0);
	ctx[z].rotate(bank * 0.25 * pi);
	ctx[z].translate(bank * -radius, 0);
	ctx[z].rotate(direction * -0.5 * pi);
	ctx[z].translate(direction * phantom.width / 2, -phantom.width / 2 + end * -phantom.width / 4);
};

function oRoll (z, distance, direction, start) {
	ctx[z].translate(direction * phantom.width / 2, phantom.width / 2 - start * phantom.width / 4);
	ctx[z].translate(direction * distance * phantom.width, 0);
	ctx[z].translate(direction * phantom.width / 2, -phantom.width / 2 + start * -phantom.width / 4);
};

function oStraight (z, distance) {
	ctx[z].translate(0, (distance + 1) * -phantom.width);
};

function oTurn (z, distance, direction) {
	var radius = rTurn[distance];
	ctx[z].translate(direction * radius, 0);
	ctx[z].rotate(direction * 0.5 * pi);
	ctx[z].translate(direction * -radius, -phantom.width);
};

function animate (flightplan, phase) {
	switch (flightplan[0]) {
		case "bank":
			animateBank(flightplan, phase);
			break;
		case "bankroll":
			animateBankroll(flightplan, phase);
			break;
		case "roll":
			animateRoll(flightplan, phase);
			break;
		case "straight":
			animateStraight(flightplan, phase);
			break;
		case "turn":
			animateTurn(flightplan, phase);
			break;
	};
};

function animateBank (flightplan, phase) {
	var distance = flightplan[2];
	var direction = flightplan[3];
	var radius = rBank[distance];
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].save();
		ctx[j].translate(direction * radius, 0);
		ctx[j].rotate(timer[phase + 1] * direction * 0.0025 * pi);
	};
	ctx[1].globalAlpha = (1 - 0.5 * ((phase == 0) ? (timer[3] / 100) : 0)) * 0.5 * timer[phase + 1] / 100;
	ctx[1].beginPath();
	ctx[1].arc (0, 0, radius, (0.5 + direction * 0.5) * pi, (0.5 + direction * 0.5  + direction * timer[phase + 1] * -0.0025) * pi, (direction == 1) ? true : false);
	ctx[1].strokeStyle = flightplan[1];
	ctx[1].lineWidth = phantom.width / 2;
	ctx[1].stroke();
	drawPhantom (3, direction * -radius, timer[phase] / 100 * -phantom.width, (1 - 0.7 * ((phase == 0) ? (timer[3] / 100) : 0)) * (0.1 * timer[phase] / 100 + 0.9 * timer[phase + 1] / 100));
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].restore();
	};
	if (phase == 0 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oBank(j, distance, direction);
		};
		for (var j = dial.length; j > 0; j--) {
			animate(dial[j-1], 2);
		};
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
	if (phase == 2 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oBank(j, distance, direction);
		};
		animateRoll(["roll", "purple", 1, -1, 1], 4);
		animateRoll(["roll", "purple", 1, -1, -1], 4);
		animateRoll(["roll", "purple", 1, 1, 1], 4);
		animateRoll(["roll", "purple", 1, 1, -1], 4);
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
	if (phase == 2 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oBank(j, distance, direction);
		};
		animateBank(["bank", "purple", 1, -1], 6);
		animateStraight(["straight", "purple", 1], 6);
		animateBank(["bank", "purple", 1, 1], 6);
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
};

function animateBankroll (flightplan, phase) {
	var distance = flightplan[2];
	var direction = flightplan[3];
	var start = flightplan[4];
	var bank = flightplan[5];
	var radius = rBank[distance];
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].save();
		ctx[j].translate(direction * phantom.width / 2, phantom.width / 2 - start * phantom.width / 4);
		ctx[j].rotate(direction * 0.5 * pi);
		ctx[j].translate(bank * radius, 0);
		ctx[j].rotate(timer[phase + 1] * bank * 0.0025 * pi);
	};
	ctx[1].globalAlpha = (1 - 0.5 * ((phase == 0) ? (timer[3] / 100) : 0)) * 0.5 * timer[phase + 1] / 100;
	ctx[1].beginPath();
	ctx[1].arc (0, 0, radius, (0.5 + bank * 0.5) * pi, (0.5 + bank * 0.5  + bank * timer[phase + 1] * -0.0025) * pi, (bank == 1) ? true : false);
	ctx[1].strokeStyle = flightplan[1];
	ctx[1].lineWidth = phantom.width / 2;
	ctx[1].stroke();
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].rotate(direction * -0.5 * pi);
		ctx[j].translate(direction * phantom.width / 2, -phantom.width * 3 / 4);
	};
	drawPhantom(3, (1 - timer[phase] / 100) * direction * -phantom.width, (1 - timer[phase] / 100 * (0.5 + 0.5 * start)) * phantom.width / 2 + (-0.5 + 0.5 * start) * phantom.width / 2 - direction * bank * radius, (1 - 0.7 * ((phase == 0) ? (timer[3] / 100) : 0)) * (0.1 * timer[phase] / 100 + 0.9 * timer[phase + 1] / 100));
	drawPhantom(3, (1 - timer[phase] / 100) * direction * -phantom.width, (1 + timer[phase] / 100 * (0.5 - 0.5 * start)) * phantom.width / 2 + (-0.5 + 0.5 * start) * phantom.width / 2 - direction * bank * radius, (1 - 0.7 * ((phase == 0) ? (timer[3] / 100) : 0)) * (0.1 * timer[phase] / 100 + 0.9 * timer[phase + 1] / 100));
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].restore();
	};
	if (phase == 0 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oBankroll(j, distance, direction, start, 1, bank);
		};
		for (var j = dial.length; j > 0; j--) {
			animate(dial[j-1], 2);
		};
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
			ctx[j].save();
			oBankroll(j, distance, direction, start, -1, bank);
		};
		for (var j = dial.length; j > 0; j--) {
			animate(dial[j-1], 2);
		};
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
};

function animateRoll (flightplan, phase) {
	var distance = flightplan[2];
	var direction = flightplan[3];
	var start = flightplan[4];
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].save();
		ctx[j].translate(direction * phantom.width / 2, phantom.width / 2 - start * phantom.width / 4);
		ctx[j].rotate(direction * 0.5 * pi);
	};
	ctx[1].globalAlpha = (1 - 0.5 * ((phase == 0) ? (timer[3] / 100) : 0)) * 0.5 * timer[phase + 1] / 100;
	ctx[1].beginPath();
	ctx[1].moveTo(0, 0);
	ctx[1].lineTo(0, timer[phase + 1] / 100 * distance * -(phantom.width + 1));
	ctx[1].strokeStyle = flightplan[1];
	ctx[1].lineWidth = phantom.width / 2;
	ctx[1].stroke();
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].rotate(direction * -0.5 * pi);
		ctx[j].translate(direction * phantom.width / 2, -phantom.width * 3 / 4);
	};
	drawPhantom(3, (1 - timer[phase] / 100) * distance * direction * -phantom.width + timer[phase + 1] / 100 * distance * direction * phantom.width, (1 - timer[phase] / 100) * start * phantom.width / 2 + (1 - start) * phantom.width / 4, (1 - 0.7 * ((phase == 0) ? (timer[3] / 100) : 0)) * (0.1 * timer[phase] / 100 + 0.9 * timer[phase + 1] / 100));
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].restore();
	};
	if (phase == 0 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oRoll(j, distance, direction, start);
		};
		for (var j = dial.length; j > 0; j--) {
			animate(dial[j-1], 2);
		};
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
};

function animateStraight (flightplan, phase) {
	var distance = flightplan[2];
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].save();
	};
	ctx[1].globalAlpha = (1 - 0.5 * ((phase == 0) ? (timer[3] / 100) : 0)) * 0.5 * timer[phase + 1] / 100;
	ctx[1].beginPath();
	ctx[1].moveTo(0, 0);
	ctx[1].lineTo(0, timer[phase + 1] / 100 * distance * -phantom.width);
	ctx[1].strokeStyle = flightplan[1];
	ctx[1].lineWidth = phantom.width / 2;
	ctx[1].stroke();
	drawPhantom(3, 0, timer[phase] / 100 * -phantom.width + timer[phase + 1] / 100 * distance * -phantom.width, (1 - 0.7 * ((phase == 0) ? (timer[3] / 100) : 0)) * (0.1 * timer[phase] / 100 + 0.9 * timer[phase + 1] / 100));
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].restore();
	};
	if (phase == 0 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oStraight(j, distance);
		};
		for (var j = dial.length; j > 0; j--) {
			animate(dial[j-1], 2);
		};
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
	if (phase == 2 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oStraight(j, distance);
		};
		animateRoll(["roll", "purple", 1, -1, 1], 4);
		animateRoll(["roll", "purple", 1, -1, -1], 4);
		animateRoll(["roll", "purple", 1, 1, 1], 4);
		animateRoll(["roll", "purple", 1, 1, -1], 4);
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
	if (phase == 2 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oStraight(j, distance);
		};
		animateBank(["bank", "purple", 1, -1], 6);
		animateStraight(["straight", "purple", 1], 6);
		animateBank(["bank", "purple", 1, 1], 6);
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
};

function animateTurn (flightplan, phase) {
	var distance = flightplan[2];
	var direction = flightplan[3];
	var radius = rTurn[distance];
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].save();
		ctx[j].translate(direction * radius, 0);
		ctx[j].rotate(timer[phase + 1] * direction * 0.005 * pi);
	};
	ctx[1].globalAlpha = (1 - 0.5 * ((phase == 0) ? (timer[3] / 100) : 0)) * 0.5 * timer[phase + 1] / 100;
	ctx[1].beginPath();
	ctx[1].arc (0, 0, radius, (0.5 + direction * 0.5) * pi, (0.5 + direction * 0.5  + direction * timer[phase + 1] * -0.005) * pi, (direction == 1) ? true : false);
	ctx[1].strokeStyle = flightplan[1];
	ctx[1].lineWidth = phantom.width / 2;
	ctx[1].stroke();
	drawPhantom(3, direction * -radius, timer[phase] / 100 * -phantom.width, (1 - 0.7 * ((phase == 0) ? (timer[3] / 100) : 0)) * (0.1 * timer[phase] / 100 + 0.9 * timer[phase + 1] / 100));
	for (var j = 1; j < ctx.length; j++) {
		ctx[j].restore();
	};
	if (phase == 2 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oTurn(j, distance, direction);
		};
		animateRoll(["roll", "purple", 1, -1, 1], 4);
		animateRoll(["roll", "purple", 1, -1, -1], 4);
		animateRoll(["roll", "purple", 1, 1, 1], 4);
		animateRoll(["roll", "purple", 1, 1, -1], 4);
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
	if (phase == 2 && timer[phase + 1] >= 100) {
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].save();
			oTurn(j, distance, direction);
		};
		animateBank(["bank", "purple", 1, -1], 6);
		animateStraight(["straight", "purple", 1], 6);
		animateBank(["bank", "purple", 1, 1], 6);
		for (var j = 1; j < ctx.length; j++) {
			ctx[j].restore();
		};
	};
};

function decloakGrid (version) {
	var tDecloak = document.getElementById("tDecloak");
	while (tDecloak.rows.length > 0) {
		tDecloak.deleteRow(0);
	};
	var newRow = tDecloak.insertRow(tDecloak.rows.length);
	var newCell = newRow.insertCell(newRow.cells.length);
	newCell.width = 23;
	newCell = newRow.insertCell(newRow.cells.length);
	if (version == 1) {
		newCell = newRow.insertCell(newRow.cells.length);
		newCell.className = "decloak";
		newCell.innerHTML = '<img src="bankC.png"><img id="decloak0" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(0);">';
		newCell = newRow.insertCell(newRow.cells.length);
		newCell.className = "decloak";
		newCell.innerHTML = '<img src="bankC.png" class="mirror"><img id="decloak1" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(1);">';
	} else {
		newCell = newRow.insertCell(newRow.cells.length);
		newCell.width = 10;
		newCell = newRow.insertCell(newRow.cells.length);
		newCell.className = "decloak";
		newCell.innerHTML = '<img src="straightC.png"><img id="decloak0" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(0);">';
		newCell.width = 21;
		newCell = newRow.insertCell(newRow.cells.length);
		newCell.width = 10;
	};
	newRow = tDecloak.insertRow(tDecloak.rows.length);
	newCell = newRow.insertCell(newRow.cells.length);
	newCell.height = 20;
	newCell = newRow.insertCell(newRow.cells.length);
	newCell.className = "decloak";
	if (version == 1) {
		newCell.innerHTML = '<img src="bankC.png" style="transform: rotate(90deg) scale(1, -1); -webkit-transform: rotate(90deg) scale(1, -1);"><img id="decloak2" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(2, 3);">';
	} else {
		newCell.innerHTML = '<img src="straightC.png" style="transform: rotate(-90deg); -webkit-transform: rotate(-90deg);"><img id="decloak1" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(1);">';
	};
	newCell = newRow.insertCell(newRow.cells.length);
	newCell.className = "decloak";
	if (version == 1) {
		newCell.colSpan = 2;
	} else {
		newCell.colSpan = 3;
	};
	newCell.rowSpan = 2;
	newCell.innerHTML = '<img src="cloak.png"><img id="decloakA" src="blank.png" class="overlayC" width=44 height=44 onClick="setDecloak(\'all\');">';
	newCell = newRow.insertCell(newRow.cells.length);
	newCell.className = "decloak";
	if (version == 1) {
		newCell.innerHTML = '<img src="bankC.png" style="transform: rotate(90deg); -webkit-transform: rotate(90deg);"><img id="decloak4" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(4, 5);">';
	} else {
		newCell.innerHTML = '<img src="straightC.png" style="transform: rotate(90deg); -webkit-transform: rotate(90deg);"><img id="decloak2" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(2);">';
	};
	newRow = tDecloak.insertRow(tDecloak.rows.length);
	newCell = newRow.insertCell(newRow.cells.length);
	newCell = newRow.insertCell(newRow.cells.length);
	newCell.className = "decloak";
	if (version == 1) {
		newCell.innerHTML = '<img src="bankC.png" style="transform: rotate(-90deg); -webkit-transform: rotate(-90deg);"><img id="decloak6" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(6, 7);">';
	} else {
		newCell.innerHTML = '<img src="straightC.png" style="transform: rotate(-90deg); -webkit-transform: rotate(-90deg);"><img id="decloak3" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(3);">';
	};
	newCell = newRow.insertCell(newRow.cells.length);
	newCell.className = "decloak";
	if (version == 1) {
		newCell.innerHTML = '<img src="bankC.png" style="transform: rotate(-90deg) scale(1, -1); -webkit-transform: rotate(-90deg) scale(1, -1);"><img id="decloak8" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(8, 9);">';
	} else {
		newCell.innerHTML = '<img src="straightC.png" style="transform: rotate(90deg); -webkit-transform: rotate(90deg);"><img id="decloak4" src="blank.png" class="overlayC" width=20 height=20 onClick="setDecloak(4);">';
	};
};
-->
</script>
</head>
<body bgcolor=black>

<table cellpadding=0 cellspacing=0>
<tr>
<td width=810 rowspan=9></td>
<td style="vertical-align:top">
<table cellpadding=0 width=158>
<tr>
<td class="button"><img src="grid.png" class="overlay" style="z-index: -1">
<a id="grid_level"></a>
<img id="button_grid" src="blank.png" class="overlay" style="opacity: 0.5;" width=50 height=50 onClick="gridfield();"></td>
<td class="button"><img src="stars.png" class="overlay"><img id="button_star" src="blank.png" class="overlay" style="opacity: 0.5;" width=50 height=50 onClick="starfield(stars);"></td>
<td class="button"><img src="loop.png" class="overlay"><img id="button_loop" src="blank.png" class="overlay" style="opacity: 0.5;" width=50 height=50 onClick="loop();"></td>
</tr>
</table>
</td>
</tr>
<tr>
<td height=20></td>
</tr>
<tr>
<td style="vertical-align: top;" height=75>
<table cellpadding=0 id="tDecloak">
</table>
</td>
</tr>
<tr>
<td height=10></td>
</tr>
<tr>
<td style="vertical-align:top">
<table cellpadding=0>
<tr>
<td class="move">4</td>
<td></td>
<td></td>
<td class="move"><img src="straightW.png"><img id="dial12" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(12);"></td>
<td></td>
<td></td>
</tr>
<tr>
<td class="move">3</td>
<td class="move"><img src="turnW.png"><img id="dial7" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(7);"></td>
<td class="move"><img src="bankW.png"><img id="dial8" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(8);"></td>
<td class="move"><img src="straightG.png"><img id="dial9" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(9);"></td>
<td class="move"><img src="bankW.png" class="mirror"><img id="dial10" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(10);"></td>
<td class="move"><img src="turnW.png" class="mirror"><img id="dial11" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(11);"></td>
</tr>
<tr>
<td class="move">2</td>
<td class="move"><img src="turnW.png"><img id="dial2" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(2);"></td>
<td class="move"><img src="bankG.png"><img id="dial3" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(3);"></td>
<td class="move"><img src="straightG.png"><img id="dial4" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(4);"></td>
<td class="move"><img src="bankG.png" class="mirror"><img id="dial5" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(5);"></td>
<td class="move"><img src="turnW.png" class="mirror"><img id="dial6" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(6);"></td>
</tr>
<tr>
<td class="move">1</td>
<td class="move"><img src="turnW.png"><img id="dial0" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(0);"></td>
<td class="move" colspan=3>ALL<img src="blank.png" id="all" class="overlayM" width=55 height=20 onClick="setDial('all');"></td>
<td class="move"><img src="turnW.png" class="mirror"><img id="dial1" src="blank.png" class="overlayM" width=17 height=20 onClick="setDial(1);"></td>
</tr>
</table>
</td>
</tr>
<tr>
<td height=10></td>
</tr>
<tr>
<td>
<table cellpadding=0>
<tr>
<td class="options">
<img src="rollG.png">
<img id="button_barrel" src="blank.png" class="overlay" width=38 height=30 onClick="barrel_roll();" style="opacity: 0.5">
</td>
<td class="options">
<img src="boostG.png">
<img id="button_boost" src="blank.png" class="overlay" width=38 height=30 onClick="boost();" style="opacity: 0.5">
</td>
<td class="options">
<img src="fireR.png" class="overlay" style="z-index: -1">
<a id="fire_range">&nbsp;</a>
<img id="button_fire" src="blank.png" class="overlay" width=38 height=30 onClick="fire();" style="opacity: 0.5">
</td>
</tr>
</table>
</td>
</tr>
<tr>
<td height=10></td>
</tr>
<tr>
<td>
<table>
<tr>
<td style="position: relative;">
<a id="select_empire" class="select">Galactic Empire</a>
<a id="select_phantom" class="select" style="position: absolute; top: 20; left: 15" onClick="select(phantom);">TIE Phantom</a>
<a id="select_echo" class="select" style="position: absolute; top: 40; left: 30" onClick="select(phantom, echo);">"Echo"</a>
</td>
</tr>
</table>
</td>
</tr>
</table>
<canvas id="layer0" width="800" height="600"></canvas>
<canvas id="gridlayer" width="800" height="600"></canvas>
<canvas id="layer1" width="800" height="600"></canvas>
<canvas id="layer2" width="800" height="600" style="opacity: 0.5;"></canvas>
<canvas id="layer3" width="800" height="600"></canvas>
</body>
</html>